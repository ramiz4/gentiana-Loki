name: Deploy to GitHub Pages

on:
  # Trigger on push to main branch
  push:
    branches:
      - main
  # Allow manual triggering from Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write  # Required to push to gh-pages branch

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build and deploy job
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build site
        run: |
          echo "Building static site..."
          # Install Tailwind CSS
          npm install -D tailwindcss @tailwindcss/cli

          # Build Tailwind CSS
          npx tailwindcss -i ./tailwind-input.css -o ./styles.css --minify

          mkdir -p _site
          # Copy the main website files
          cp index.html _site/
          cp styles.css _site/
          cp script.js _site/
          cp favicon.svg _site/

          echo "✓ Copied index.html"
          echo "✓ Copied compiled styles.css"
          echo "✓ Copied script.js"
          echo "✓ Copied favicon.svg"

          # Copy PDF if it exists
          if [ -f cv-de-gentiana-loki-2026.pdf ]; then
            cp cv-de-gentiana-loki-2026.pdf _site/
            echo "✓ Copied PDF file"
          fi
          echo "Build completed successfully"

      - name: Checkout gh-pages branch
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-content

      - name: Clean up stale production files
        run: |
          if [ -d "gh-pages-content" ]; then
            echo "Cleaning up stale production files while preserving PR previews..."
            cd gh-pages-content
            # Remove all files in root except pr-* directories and .git
            find . -maxdepth 1 ! -name '.' ! -name '.git' ! -name 'pr-*' -exec rm -rf {} +
            echo "✓ Removed stale production files, preserved pr-* directories"
            cd ..
            # Copy new build into the cleaned directory
            cp -r _site/* gh-pages-content/
            echo "✓ Copied new site content to deployment directory"
          else
            echo "ℹ gh-pages branch doesn't exist yet, using build directory directly"
            mkdir -p gh-pages-content
            cp -r _site/* gh-pages-content/
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-content
          keep_files: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: "Deploy production site"
